<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Geospatial Data Interaction</title>
    <!-- Style Sheets-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" >
    <link rel="stylesheet" href="https://dc-js.github.io/dc.js/css/dc.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <!--<link rel="stylesheet" href="../../dist/storymap.css">-->
    <link rel="stylesheet" href="css/main.css">
    <!--<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">-->
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
    <!-- Javascript Libraries-->
    <script src="https://dc-js.github.io/dc.js/js/d3.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/dc.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@5.0.0/dist/simple-statistics.min.js"></script>
    <script src="https://unpkg.com/leaflet.nontiledlayer/dist/NonTiledLayer.js"></script>
    <!--<script src="../../dist/storymap.js"></script>-->
    <script src="js/pako.min.js"></script>
    <script src="js/UPNG.js"></script>

</head>

<body>

<div class="container title">
    <h1>The Will of the People<br><small>All ballots are not cast equally</small></h1>
</div>

<div class="container-fluid ">
    <div class="row top-buffer">
        <div class="col-xs-4">
            <p>What if every elected delegate represented the same number of votes? What if every ballot cast had the same weight in the nomination process? Would it change the number of delegates allocated to each candidate?</p>
            <p>The Supreme Court recently confirmed the "One person, one vote" principle. But it applies for elections, not primaries. Delegate allocation is managed at the State level and different procedures rule the allocation (caucus vs. primary, winner-takes-all vs. proportional, etc.). These mechanisms lead to different situations, and some votes matter more than others. Who gets overrepresented? A republican from Utah? A democrat from San Francisco? Which candidate is favored by the disparity of procedures?</p>
        </div>
        <div class="col-xs-4">
            <p>These maps and charts compare two situations: 1) The ‘What if’ situation where the number of delegates allocated to each candidate reflects the actual number of votes it received. Opacity of counties accounts for population. 2) The actual situation where some citizens have more influence on the output of the nomination than others. Opacity accounts for the ratio delegates/votes for a given county.</p>
            <p>The ratio delegates/votes is calculated for every county and both parties according to a score each State receives (the number of delegates it sends divided by the overall turnout in this State), multiplied by the number of votes in this particular county.</p>
        </div>
        <div class="col-xs-4">
            <p>Caucuses typically lead to a low turnout (Utah’s republican caucus for instance) ushering in a high ratio. Some counties’ high ratio might also be due to a weak representation of one of the parties (District of Columbia’s republican convention for instance where 2,810 voters elected 19 delegates). This analysis omits the fact that early voting States have a higher impact on who gets to stay in the race (cf. the precocious dropout of Jeb Bush). This model assumes that delegates are allocated statewide and not per county or congressional district, which is actually not the case everywhere.</p>
        </div>
    </div> <!-- END OF ROW -->

    <div class="row top-buffer">
        <div class="col-xs-7">
        </div>
        <div class="col-xs-4">

        </div>

    </div> <!-- END OF ROW -->

<div class = "row main-panel">

    <div id='map' class="col-md-6 col-lg-6">
        <canvas id="mycanvas"></canvas>
    </div>
    <div class="col-md-6 col-lg-6">
        <div id="mag-chart"></div>
    </div>
</div>


    <!--<div class="row">-->
        <!--<h4>Count by Depth(m)</h4>-->
        <!--<div id="depth-chart"></div>-->
    <!--</div>-->
    <!--<div class="row">-->
        <!--<h4>Count by Day</h4>-->
        <!--<div id="date-chart"></div>-->
    <!--</div>-->
</div>


<script type="text/javascript">

    // https://github.com/stuartmatthews/Leaflet.NonTiledLayer.WCS
    // manipulate Uint8Array
    // http://geoexamples.com/d3-raster-tools-docs/intr/reading-raster-data.html
    // http://www.henryalgus.com/reading-binary-files-using-jquery-ajax/
    // https://github.com/photopea/UPNG.js?files=1

    var map = L.map('map').setView([45, -119], 6);

    // a = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);

    a = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

    L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}@2x.png').addTo(map);

    b = L.nonTiledLayer.wms('http://mapious.ceoas.oregonstate.edu/geoserver/wms?', {
//        maxZoom: 19,
//        minZoom: 0,
        layers: 'whole',
        format: 'image/png',
        transparent: 'true',
        opacity: 0.8
    }).addTo(map);

var data = null;

    function updateMapFilter() {

        url= b._ctx.canvas._image.src;
        //console.log(src);
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) {
            tt = this.response;
            var img  = UPNG.decode(tt);
            var rgba = UPNG.toRGBA8(img)[0];
            var h = img.height;
            var w = img.width;
            var ctype = img.ctype;
            var depth = img.depth;
            data = img.data;

            console.log("depth:" + depth.toString());
            console.log("ctype:" + ctype.toString());
            console.log("mean:" + ss.mean(data).toString());
            console.log("median:" + ss.median(data).toString());
            console.log(data);


            var dataarray = Array.from(data);
            //var dataarray = uint8ArrayToArray(data);

            //create crossfilter and filter all the data.
            var filter = crossfilter(dataarray); //Create a crossfilter, input all the geospatial data.


            //create charts
            var magChart = dc.barChart('#mag-chart');

            var magDimension = filter.dimension(function(d) {
                var mag = d;
                return  mag < 0.2 ? '1-1.2' :
                    mag < 0.3 ? '1.2-1.5' :
                        mag <   0.4 ? '1.5-2' :
                            mag < 0.5 ? '2-2.5' :
                                mag <   0.6 ? '2.5-3' :
                                    '>3'
            });

            var magDimensionGroup = magDimension.group();

            magChart
                .height(400)
                .margins({top: 10, right: 50, bottom: 30, left: 40})
                .dimension(magDimension)
                .group(magDimensionGroup)
                .elasticY(true)
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                .yAxis()
                .ticks(3);

            dc.renderAll();


        };

        xhr.send();

        dc.redrawAll();

    }

    updateMapFilter();
    map.on('moveend',updateMapFilter);
    map.on('zoomend',updateMapFilter);

</script>
</body>
</html>